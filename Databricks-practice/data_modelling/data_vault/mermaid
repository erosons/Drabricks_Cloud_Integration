# Complete Data Vault 2.0 ETL Implementation

## Business Scenario: Retail Sales Data Vault

Building a scalable, auditable, and flexible enterprise data warehouse using Data Vault 2.0 methodology for retail operations.

---

## 1. ARCHITECTURE DIAGRAMS

### 1.1 Complete Data Vault Architecture Overview

```mermaid
graph TB
    subgraph "Source Systems"
        OLTP1[OLTP Database]
        OLTP2[ERP System]
        FILES[CSV/Files]
    end
    
    subgraph "Staging Layer"
        STG[Staging Tables<br/>Raw Data Load]
    end
    
    subgraph "Raw Data Vault"
        subgraph "Hubs"
            H1[Hub Customer<br/>Business Keys]
            H2[Hub Product<br/>Business Keys]
            H3[Hub Store<br/>Business Keys]
            H4[Hub Transaction<br/>Business Keys]
            H5[Hub Promotion<br/>Business Keys]
        end
        
        subgraph "Links"
            L1[Link Sales<br/>5-Way Relationship]
            L2[Link Product-Promotion<br/>2-Way Relationship]
        end
        
        subgraph "Satellites"
            S1[Sat Customer Details]
            S2[Sat Customer Contact]
            S3[Sat Product Details]
            S4[Sat Product Pricing]
            S5[Sat Store Details]
            S6[Sat Transaction Details]
            S7[Sat Promotion Details]
            S8[Sat Sales Metrics]
        end
    end
    
    subgraph "Business Vault"
        PIT1[PIT Customer<br/>Query Optimization]
        PIT2[PIT Product<br/>Query Optimization]
        BRIDGE[Bridge Tables<br/>Complex Relationships]
    end
    
    subgraph "Information Marts"
        DM1[Sales Mart<br/>Star Schema]
        DM2[Customer Mart<br/>Star Schema]
        CUBE[OLAP Cubes]
    end
    
    subgraph "Presentation Layer"
        BI[BI Tools<br/>Tableau/PowerBI]
        REPORT[Reports<br/>Dashboards]
    end
    
    OLTP1 --> STG
    OLTP2 --> STG
    FILES --> STG
    
    STG --> H1
    STG --> H2
    STG --> H3
    STG --> H4
    STG --> H5
    
    H1 --> L1
    H2 --> L1
    H3 --> L1
    H4 --> L1
    H5 --> L1
    
    H2 --> L2
    H5 --> L2
    
    H1 --> S1
    H1 --> S2
    H2 --> S3
    H2 --> S4
    H3 --> S5
    H4 --> S6
    H5 --> S7
    L1 --> S8
    
    S1 --> PIT1
    S2 --> PIT1
    S3 --> PIT2
    S4 --> PIT2
    
    H1 --> BRIDGE
    H2 --> BRIDGE
    L1 --> BRIDGE
    
    PIT1 --> DM1
    PIT2 --> DM1
    BRIDGE --> DM2
    
    DM1 --> CUBE
    DM2 --> CUBE
    
    CUBE --> BI
    CUBE --> REPORT
    
    style H1 fill:#4A90E2
    style H2 fill:#4A90E2
    style H3 fill:#4A90E2
    style H4 fill:#4A90E2
    style H5 fill:#4A90E2
    style L1 fill:#E24A90
    style L2 fill:#E24A90
    style S1 fill:#50C878
    style S2 fill:#50C878
    style S3 fill:#50C878
    style S4 fill:#50C878
    style S5 fill:#50C878
    style S6 fill:#50C878
    style S7 fill:#50C878
    style S8 fill:#50C878
    style PIT1 fill:#FFB347
    style PIT2 fill:#FFB347
```

### 1.2 Hub-Link-Satellite Detailed Structure

```mermaid
graph TB
    subgraph "Hub Customer"
        HC[hub_customer_hk PK<br/>customer_id NK<br/>load_date<br/>record_source]
    end
    
    subgraph "Hub Product"
        HP[hub_product_hk PK<br/>product_id NK<br/>load_date<br/>record_source]
    end
    
    subgraph "Hub Store"
        HS[hub_store_hk PK<br/>store_id NK<br/>load_date<br/>record_source]
    end
    
    subgraph "Hub Transaction"
        HT[hub_transaction_hk PK<br/>transaction_id NK<br/>load_date<br/>record_source]
    end
    
    subgraph "Hub Promotion"
        HPR[hub_promotion_hk PK<br/>promotion_id NK<br/>load_date<br/>record_source]
    end
    
    subgraph "Link Sales"
        LS[link_sales_hk PK<br/>hub_customer_hk FK<br/>hub_product_hk FK<br/>hub_store_hk FK<br/>hub_transaction_hk FK<br/>hub_promotion_hk FK<br/>load_date<br/>record_source]
    end
    
    subgraph "Satellite Customer Details"
        SCD[hub_customer_hk FK<br/>load_date PK<br/>load_end_date<br/>hash_diff<br/>first_name<br/>last_name<br/>birth_date<br/>gender<br/>customer_segment<br/>registration_date]
    end
    
    subgraph "Satellite Product Pricing"
        SPP[hub_product_hk FK<br/>load_date PK<br/>load_end_date<br/>hash_diff<br/>unit_cost<br/>unit_price<br/>currency]
    end
    
    subgraph "Satellite Sales Metrics"
        SSM[link_sales_hk FK<br/>load_date PK<br/>load_end_date<br/>hash_diff<br/>quantity<br/>unit_price<br/>discount_amount<br/>tax_amount<br/>total_amount<br/>cost<br/>profit]
    end
    
    HC -->|1:M| SCD
    HP -->|1:M| SPP
    
    HC -->|1:M| LS
    HP -->|1:M| LS
    HS -->|1:M| LS
    HT -->|1:M| LS
    HPR -->|1:M| LS
    
    LS -->|1:M| SSM
    
    style HC fill:#4A90E2,color:#fff
    style HP fill:#4A90E2,color:#fff
    style HS fill:#4A90E2,color:#fff
    style HT fill:#4A90E2,color:#fff
    style HPR fill:#4A90E2,color:#fff
    style LS fill:#E24A90,color:#fff
    style SCD fill:#50C878,color:#fff
    style SPP fill:#50C878,color:#fff
    style SSM fill:#50C878,color:#fff
```

### 1.3 ETL Workflow - Parallel Loading

```mermaid
graph LR
    subgraph "Extract Phase"
        E1[Extract from<br/>OLTP System]
        E2[Extract from<br/>ERP System]
        E3[Extract from<br/>Files]
    end
    
    subgraph "Staging"
        STG[Stage All Data<br/>Minimal Transform]
    end
    
    subgraph "Phase 1: Load Hubs - PARALLEL"
        H1[Load Hub<br/>Customer]
        H2[Load Hub<br/>Product]
        H3[Load Hub<br/>Store]
        H4[Load Hub<br/>Transaction]
        H5[Load Hub<br/>Promotion]
    end
    
    subgraph "Phase 2: Load Links"
        L1[Load Link<br/>Sales]
        L2[Load Link<br/>Product-Promotion]
    end
    
    subgraph "Phase 3: Load Satellites - PARALLEL"
        S1[Load Sat<br/>Customer Details]
        S2[Load Sat<br/>Customer Contact]
        S3[Load Sat<br/>Product Details]
        S4[Load Sat<br/>Product Pricing]
        S5[Load Sat<br/>Store Details]
        S6[Load Sat<br/>Sales Metrics]
    end
    
    subgraph "Phase 4: Business Vault"
        PIT[Build PIT<br/>Tables]
        BRG[Build Bridge<br/>Tables]
    end
    
    subgraph "Phase 5: Information Marts"
        MART[Build Dimensional<br/>Marts]
    end
    
    E1 --> STG
    E2 --> STG
    E3 --> STG
    
    STG --> H1
    STG --> H2
    STG --> H3
    STG --> H4
    STG --> H5
    
    H1 --> L1
    H2 --> L1
    H3 --> L1
    H4 --> L1
    H5 --> L1
    
    H2 --> L2
    H5 --> L2
    
    L1 --> S1
    L1 --> S2
    L1 --> S3
    L1 --> S4
    L1 --> S5
    L1 --> S6
    
    S1 --> PIT
    S2 --> PIT
    S3 --> PIT
    S4 --> PIT
    
    PIT --> BRG
    BRG --> MART
    
    style STG fill:#FFE4B5
    style H1 fill:#4A90E2,color:#fff
    style H2 fill:#4A90E2,color:#fff
    style H3 fill:#4A90E2,color:#fff
    style H4 fill:#4A90E2,color:#fff
    style H5 fill:#4A90E2,color:#fff
    style L1 fill:#E24A90,color:#fff
    style L2 fill:#E24A90,color:#fff
    style S1 fill:#50C878,color:#fff
    style S2 fill:#50C878,color:#fff
    style S3 fill:#50C878,color:#fff
    style S4 fill:#50C878,color:#fff
    style S5 fill:#50C878,color:#fff
    style S6 fill:#50C878,color:#fff
    style PIT fill:#FFB347
    style BRG fill:#FFB347
    style MART fill:#DDA0DD
```

### 1.4 Historical Tracking in Satellites

```mermaid
gantt
    title Product Price History Timeline (Satellite Versioning)
    dateFormat YYYY-MM-DD
    
    section Product A
    Version 1 ($10.00)           :v1, 2024-01-01, 2024-03-15
    Version 2 ($12.00)           :v2, 2024-03-15, 2024-06-01
    Version 3 ($11.50)           :v3, 2024-06-01, 2024-12-31
    
    section Product B
    Version 1 ($25.00)           :v4, 2024-01-01, 2024-02-15
    Version 2 ($27.50)           :v5, 2024-02-15, 2024-05-01
    Version 3 ($26.00)           :v6, 2024-05-01, 2024-08-15
    Version 4 ($28.00)           :v7, 2024-08-15, 2024-12-31
```

### 1.5 Satellite Change Detection Flow

```mermaid
flowchart TD
    START([New Data Arrives]) --> HASH[Generate Hash Key<br/>from Business Key]
    HASH --> HASHDIFF[Generate Hash Diff<br/>from Attributes]
    HASHDIFF --> CHECK{Record Exists<br/>in Hub?}
    
    CHECK -->|No| INSERT_HUB[Insert New Hub Record]
    CHECK -->|Yes| CONTINUE[Continue to Satellite]
    
    INSERT_HUB --> CONTINUE
    
    CONTINUE --> CHECK_SAT{Satellite Record<br/>Exists?}
    
    CHECK_SAT -->|No| INSERT_SAT[Insert New<br/>Satellite Record<br/>load_end_date = NULL]
    
    CHECK_SAT -->|Yes| COMPARE{Hash Diff<br/>Changed?}
    
    COMPARE -->|No| SKIP[No Action<br/>Data Unchanged]
    
    COMPARE -->|Yes| CLOSE[Close Current Record<br/>Set load_end_date]
    CLOSE --> INSERT_NEW[Insert New Version<br/>load_end_date = NULL]
    
    INSERT_SAT --> END([Complete])
    INSERT_NEW --> END
    SKIP --> END
    
    style START fill:#90EE90
    style END fill:#FFB6C1
    style INSERT_HUB fill:#4A90E2,color:#fff
    style INSERT_SAT fill:#50C878,color:#fff
    style INSERT_NEW fill:#50C878,color:#fff
    style CLOSE fill:#FFA500,color:#fff
```

### 1.6 Time Travel Query Visualization

```mermaid
graph TB
    subgraph "Query: Sales as of 2024-03-15"
        QUERY[SELECT Sales Data<br/>WHERE date = '2024-03-15']
    end
    
    subgraph "PIT Table Lookup"
        PIT[PIT Customer<br/>snapshot_date = 2024-03-15<br/>â†’ sat_load_date = 2024-03-10]
    end
    
    subgraph "Hub Customer"
        HUB[customer_id = 'CUST001'<br/>hub_customer_hk = 'ABC123']
    end
    
    subgraph "Satellite Customer Details - Historical Versions"
        SAT1[Version 1<br/>2024-01-01 to 2024-03-10<br/>segment = 'Silver']
        SAT2[Version 2<br/>2024-03-10 to 2024-06-01<br/>segment = 'Gold']
        SAT3[Version 3<br/>2024-06-01 to NULL<br/>segment = 'Platinum']
    end
    
    subgraph "Result"
        RESULT[Customer CUST001<br/>segment = 'Gold'<br/>as it was on 2024-03-15]
    end
    
    QUERY --> PIT
    PIT --> HUB
    HUB --> SAT1
    HUB --> SAT2
    HUB --> SAT3
    
    SAT2 -.Selected by PIT.-> RESULT
    
    style QUERY fill:#FFE4B5
    style PIT fill:#FFB347
    style HUB fill:#4A90E2,color:#fff
    style SAT1 fill:#D3D3D3
    style SAT2 fill:#50C878,color:#fff
    style SAT3 fill:#D3D3D3
    style RESULT fill:#90EE90
```

### 1.7 Data Vault vs Dimensional Model Comparison

```mermaid
graph TB
    subgraph "Data Vault Approach"
        DV_SOURCE[Source Data] --> DV_HUB[Hubs<br/>Business Keys Only]
        DV_HUB --> DV_LINK[Links<br/>Relationships]
        DV_LINK --> DV_SAT[Satellites<br/>All History Tracked]
        DV_SAT --> DV_PIT[PIT Tables<br/>Query Optimization]
        DV_PIT --> DV_MART[Information Marts]
    end
    
    subgraph "Dimensional Approach"
        DIM_SOURCE[Source Data] --> DIM_STAGE[Staging]
        DIM_STAGE --> DIM_DIM[Dimensions<br/>SCD Type 2]
        DIM_STAGE --> DIM_FACT[Fact Tables<br/>Aggregated]
        DIM_DIM --> DIM_STAR[Star Schema]
        DIM_FACT --> DIM_STAR
    end
    
    subgraph "Comparison"
        COMP1[Flexibility: DV Wins]
        COMP2[History: DV Complete]
        COMP3[Query Speed: DIM Faster]
        COMP4[Agility: DV Better]
        COMP5[Complexity: DIM Simpler]
    end
    
    style DV_HUB fill:#4A90E2,color:#fff
    style DV_LINK fill:#E24A90,color:#fff
    style DV_SAT fill:#50C878,color:#fff
    style DV_PIT fill:#FFB347
    style DIM_DIM fill:#9370DB,color:#fff
    style DIM_FACT fill:#FF6347,color:#fff
```

### 1.8 Hash Key Generation Process

```mermaid
flowchart LR
    subgraph "Business Keys"
        BK1[customer_id:<br/>'CUST000001']
        BK2[product_id:<br/>'PROD000050']
        BK3[store_id:<br/>'STORE003']
    end
    
    subgraph "Standardization"
        STD1[Uppercase<br/>'CUST000001']
        STD2[Trim Spaces<br/>'PROD000050']
        STD3[Uppercase<br/>'STORE003']
    end
    
    subgraph "Hash Generation"
        CONCAT[Concatenate with ||<br/>'CUST000001||PROD000050||STORE003']
        HASH[MD5 Hash<br/>'a1b2c3d4e5f6...']
    end
    
    subgraph "Link Hash Key"
        RESULT[link_sales_hk:<br/>'a1b2c3d4e5f6...']
    end
    
    BK1 --> STD1
    BK2 --> STD2
    BK3 --> STD3
    
    STD1 --> CONCAT
    STD2 --> CONCAT
    STD3 --> CONCAT
    
    CONCAT --> HASH
    HASH --> RESULT
    
    style CONCAT fill:#FFE4B5
    style HASH fill:#FFB347
    style RESULT fill:#50C878,color:#fff
```

### 1.9 Incremental vs Full Load Strategy

```mermaid
graph TB
    subgraph "Full Load - Initial"
        FL1[Extract All Data] --> FL2[Load All Hubs]
        FL2 --> FL3[Load All Links]
        FL3 --> FL4[Load All Satellites]
        FL4 --> FL5[Build All PITs]
    end
    
    subgraph "Incremental Load - Daily"
        IL1[Extract Delta/Changes] --> IL2[Load New Hub Records Only]
        IL2 --> IL3[Load New Link Records]
        IL3 --> IL4[Update Changed Satellites<br/>Close old + Insert new]
        IL4 --> IL5[Rebuild PIT for Changed Dates]
    end
    
    subgraph "Strategy Decision"
        DEC{Data Volume &<br/>Change Rate}
        DEC -->|Initial Load| FULL[Use Full Load]
        DEC -->|Daily Updates| INCR[Use Incremental]
        DEC -->|High Volume Changes| CDC[Use CDC Stream]
    end
    
    style FL1 fill:#4A90E2,color:#fff
    style FL5 fill:#50C878,color:#fff
    style IL1 fill:#FFB347
    style IL5 fill:#90EE90
    style CDC fill:#FF6347,color:#fff
```

### 1.10 Data Lineage in Data Vault

```mermaid
graph LR
    subgraph "Source Systems"
        S1[CRM System<br/>record_source: 'CRM']
        S2[ERP System<br/>record_source: 'ERP']
        S3[Web App<br/>record_source: 'WEB']
    end
    
    subgraph "Raw Vault"
        H1[Hub Customer<br/>+ record_source<br/>+ load_date]
        SAT1[Sat Customer Details<br/>+ record_source<br/>+ load_date]
    end
    
    subgraph "Audit Trail"
        AUDIT[Complete Lineage:<br/>- Data Origin<br/>- Load Timestamp<br/>- Batch ID<br/>- ETL Version]
    end
    
    S1 -->|Batch 1| H1
    S2 -->|Batch 2| H1
    S3 -->|Batch 3| H1
    
    S1 -->|Batch 1| SAT1
    S2 -->|Batch 2| SAT1
    S3 -->|Batch 3| SAT1
    
    H1 --> AUDIT
    SAT1 --> AUDIT
    
    style S1 fill:#FFE4B5
    style S2 fill:#FFE4B5
    style S3 fill:#FFE4B5
    style H1 fill:#4A90E2,color:#fff
    style SAT1 fill:#50C878,color:#fff
    style AUDIT fill:#90EE90
```

---
